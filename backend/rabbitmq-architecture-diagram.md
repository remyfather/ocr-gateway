# RabbitMQ 아키텍처 도식화

## 새로운 구조: 각 Queue마다 전용 Exchange (1:1 바인딩)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           RabbitMQ 아키텍처                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │   Producer      │    │   Producer      │    │   Producer      │            │
│  │ (Gateway App)   │    │ (Gateway App)   │    │ (Gateway App)   │            │
│  └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘            │
│            │                      │                      │                     │
│            │                      │                      │                     │
│  ┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐            │
│  │ medical.receipt │    │medical.certif.  │    │admission.disch. │            │
│  │   .exchange     │    │   .exchange     │    │   .exchange     │            │
│  └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘            │
│            │                      │                      │                     │
│            │ (routing key:        │ (routing key:        │ (routing key:       │
│            │  "receipt")          │  "certificate")      │  "admission.disch.")│
│            │                      │                      │                     │
│  ┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐            │
│  │ medical.receipt │    │medical.certif.  │    │admission.disch. │            │
│  │   .queue        │    │   .queue        │    │   .queue        │            │
│  └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘            │
│            │                      │                      │                     │
│            │                      │                      │                     │
│  ┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐            │
│  │   Consumer      │    │   Consumer      │    │   Consumer      │            │
│  │ (OCR Worker)    │    │ (OCR Worker)    │    │ (OCR Worker)    │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                                    │
│  │   Producer      │    │   Producer      │                                    │
│  │ (Gateway App)   │    │ (Gateway App)   │                                    │
│  └─────────┬───────┘    └─────────┬───────┘                                    │
│            │                      │                                             │
│  ┌─────────▼───────┐    ┌─────────▼───────┐                                    │
│  │surgery.confirm. │    │   (Future)      │                                    │
│  │   .exchange     │    │   .exchange     │                                    │
│  └─────────┬───────┘    └─────────┬───────┘                                    │
│            │                      │                                             │
│            │ (routing key:        │ (routing key:                              │
│            │  "surgery.confirm.") │  "future")                                 │
│            │                      │                                             │
│  ┌─────────▼───────┐    ┌─────────▼───────┐                                    │
│  │surgery.confirm. │    │   (Future)      │                                    │
│  │   .queue        │    │   .queue        │                                    │
│  └─────────┬───────┘    └─────────┬───────┘                                    │
│            │                      │                                             │
│  ┌─────────▼───────┐    ┌─────────▼───────┐                                    │
│  │   Consumer      │    │   Consumer      │                                    │
│  │ (OCR Worker)    │    │ (OCR Worker)    │                                    │
│  └─────────────────┘    └─────────────────┘                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 문서 타입별 상세 구조

### 1. 진료비 영수증 (Medical Receipt)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gateway       │───▶│medical.receipt  │───▶│medical.receipt  │
│   (Producer)    │    │   .exchange     │    │   .queue        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │ routing key:           │
                              │ "receipt"              │
                              │                        │
                              │                ┌───────▼───────┐
                              │                │   OCR Worker  │
                              │                │ (Consumer)    │
                              │                └───────────────┘
```

### 2. 진단서 (Medical Certificate)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gateway       │───▶│medical.certif.  │───▶│medical.certif.  │
│   (Producer)    │    │   .exchange     │    │   .queue        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │ routing key:           │
                              │ "certificate"          │
                              │                        │
                              │                ┌───────▼───────┐
                              │                │   OCR Worker  │
                              │                │ (Consumer)    │
                              │                └───────────────┘
```

### 3. 입퇴원 확인서 (Admission/Discharge)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gateway       │───▶│admission.disch. │───▶│admission.disch. │
│   (Producer)    │    │   .exchange     │    │   .queue        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │ routing key:           │
                              │ "admission.disch."     │
                              │                        │
                              │                ┌───────▼───────┐
                              │                │   OCR Worker  │
                              │                │ (Consumer)    │
                              │                └───────────────┘
```

### 4. 수술확인서 (Surgery Confirmation)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gateway       │───▶│surgery.confirm. │───▶│surgery.confirm. │
│   (Producer)    │    │   .exchange     │    │   .queue        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │ routing key:           │
                              │ "surgery.confirm."     │
                              │                        │
                              │                ┌───────▼───────┐
                              │                │   OCR Worker  │
                              │                │ (Consumer)    │
                              │                └───────────────┘
```

## 메시지 흐름

### 1. 문서 분류 및 라우팅

```
┌─────────────────┐
│   Upload File   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ Document        │
│ Classification  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ Route to        │
│ Specific        │
│ Exchange        │
└─────────────────┘
```

### 2. 메시지 전송

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   OcrRequestDto │───▶│   Exchange      │───▶│   Queue         │
│   + Documents   │    │   (Dedicated)   │    │   (1:1 Binding) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3. 메시지 소비

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Queue         │───▶│   Consumer      │───▶│   OCR Processing│
│   (Message)     │    │   (Worker)      │    │   (Result)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 장점 비교

### 이전 구조 (1 Exchange + 다수 Queue)

```
❌ 단일 실패 지점
❌ 확장성 제한
❌ 모니터링 복잡성
❌ 장애 격리 어려움
```

### 새로운 구조 (다수 Exchange + 1:1 Queue)

```
✅ 완전한 독립성
✅ 무제한 확장성
✅ 명확한 모니터링
✅ 장애 격리
✅ 명확한 책임 분리
```

## 확장 시나리오

새로운 문서 타입 추가 시:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gateway       │───▶│new.document     │───▶│new.document     │
│   (Producer)    │    │   .exchange     │    │   .queue        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              │ routing key:           │
                              │ "new.document"         │
                              │                        │
                              │                ┌───────▼───────┐
                              │                │   OCR Worker  │
                              │                │ (Consumer)    │
                              │                └───────────────┘
```

**기존 구조에 전혀 영향 없음!** 🎉
